<!DOCTYPE html>
<html lang="en">

<head>
    <link href="styles/style.css" rel="stylesheet" type="text/css"/>
    <meta charset="UTF-8">
    <title></title>
</head>

<script>
    let map = null;
    let directionsRenderer = null;
    let infoWindow = null;
    let service = null;
    let placeType = "cafe";
    let markers = [];
    let locations = [];
    let latLng = null;
    let placeMarkers = {
        cafe: [],
        school: [],
        bar: []
    };

    // Load Map
    function loadMap() {
        const servicesCentreLocation = new google.maps.LatLng(51.43394571746091, -0.214533805847168);

        map = new google.maps.Map(document.getElementById("map"), {
            mapId: "MY_MAP_ID",
            zoom: 16,
            center: servicesCentreLocation,
            mapTypeId: google.maps.MapTypeId.ROADMAP,
            mapTypeControlOptions: {
                mapTypeIds: ["roadmap", "satellite", "hide_poi"]
            }
        });

        // Autocomplete Setup
        const startInput = document.getElementById("start");
        const endInput = document.getElementById("end");
        new google.maps.places.Autocomplete(startInput);
        new google.maps.places.Autocomplete(endInput);

        // Directions
        directionsRenderer = new google.maps.DirectionsRenderer();
        directionsRenderer.setMap(map);
        directionsRenderer.setPanel(document.getElementById("directions"));
        calculateRoute("DRIVING");


        hidePointsOfInterest(map);


        service = new google.maps.places.PlacesService(map);

        // Load Locations
        locations.forEach(location => {
            const marker = new google.maps.Marker({
                position: new google.maps.LatLng(location[LATITUDE], location[LONGITUDE]),
                map: map
            });

            if (!infoWindow) {
                infoWindow = new google.maps.InfoWindow();
            }

            // google.maps.event.addListener(marker, "click", () => {
            //     infoWindow.setContent(location[CONTENT]);
            //     infoWindow.open(map, marker);
            // });
        });

        // Click Listener
        map.addListener("click", (mapsMouseEvent) => {
            latLng = mapsMouseEvent.latLng.toJSON();

            // Check which place types are active and display them
            document.querySelectorAll('.placeTypes input[type="checkbox"]').forEach(checkbox => {
                if (checkbox.checked) {
                    togglePlaceType(checkbox.value, true);
                }
            });
        });

        document.getElementById("closePanel").addEventListener("click", () => {
            document.getElementById("infoPanel").classList.remove("visible");
        });

    }

    // Load External Locations File
    function loadLocations() {
        return fetch("locations.json")
            .then(response => {
                if (!response.ok) throw new Error("error fetching locations");
                return response.json();
            })
            .then(data => {
                locations = data.map(loc => [loc.content, loc.lat, loc.lng, loc.icon || null]);
            })
            .catch(error => console.error("Error fetching locations: ", error));
    }

    // loadLocations().then(() => {
    //     locations.forEach(location => {
    //         const iconUrl = location[3];
    //         const markerOptions = {
    //             position: new google.maps.LatLng(location[1], location[2]),
    //             map: map
    //         };
    //
    //         if (iconUrl) {
    //             markerOptions.icon = {
    //                 url: iconUrl,
    //                 scaledSize: new google.maps.Size(30, 30)
    //             };
    //         }
    //
    //         const marker = new google.maps.Marker(markerOptions);
    //
    //         if (!infoWindow) {
    //             infoWindow = new google.maps.InfoWindow();
    //         }
    //
    //         google.maps.event.addListener(marker, "click", () => {
    //             infoWindow.setContent(location[0]);
    //             infoWindow.open(map, marker);
    //         });
    //     });
    // });

    // Toggle Nearby Place Types
    function togglePlaceType(type, isChecked) {
        if (isChecked) {
            if (latLng) {
                displayNearbyPlaces(type);
            }
        } else {
            clearPlaceMarkers(type);
        }
    }
    function clearPlaceMarkers(type) {
        placeMarkers[type].forEach(marker => {
            marker.setMap(null);
        });
        placeMarkers[type] = [];
    }

    // Display Nearby Places
    function displayNearbyPlaces(type) {
        const service = new google.maps.places.PlacesService(map);

        service.nearbySearch({
            location: latLng,
            radius: 1000,
            type: type
        }, (results, status) => {
            if (status === google.maps.places.PlacesServiceStatus.OK) {
                clearPlaceMarkers(type); // Clear existing markers of this type
                results.forEach(result => {
                    createPlaceMarker(result, type);
                });
            }
        });
    }


    // Callback: Create Nearby Markers
    function getNearbyServicesMarkers(results, status) {
        if (status === google.maps.places.PlacesServiceStatus.OK) {
            results.forEach(result => {
                createPlaceMarker(result);
            });
        }
    }

    // Create Place Marker
    function createPlaceMarker(place, type) {
        if (!place.geometry || !place.geometry.location) return;

        const marker = new google.maps.Marker({
            map: map,
            position: place.geometry.location,
            icon: {
                url: place.icon,
                scaledSize: new google.maps.Size(20, 20)
            }
        });

        placeMarkers[type].push(marker);

        google.maps.event.addListener(marker, "click", () => {
            const request = {
                placeId: place.place_id,
                fields: ["name", "formatted_address", "formatted_phone_number", "url", "photos"]
            };

            service.getDetails(request, (placeDetails, status) => {
                if (status !== google.maps.places.PlacesServiceStatus.OK || !placeDetails) return;

                const content = `
                <h2>${placeDetails.name}</h2>
                ${placeDetails.photos?.[0] ? `<img src="${placeDetails.photos[0].getUrl()}" width="100%">` : ""}
                <p>${placeDetails.formatted_address?.replaceAll(", ", ",<br>") || ""}</p>
                ${placeDetails.formatted_phone_number ? `<p>${placeDetails.formatted_phone_number}</p>` : ""}
                ${placeDetails.url ? `<p><a href="${placeDetails.url}" target="_blank">View on Google Maps</a></p>` : ""}
            `;

                const infoPanel = document.getElementById("infoPanel");
                const infoPanelContent = document.getElementById("infoPanelContent");
                infoPanelContent.innerHTML = content;
                infoPanel.classList.add("visible");
            });
        });
    }

    // Hide POIs and Transit Icons
    function hidePointsOfInterest(map) {
        const styles = [
            { featureType: "poi", stylers: [{ visibility: "off" }] },
            { featureType: "transit", stylers: [{ visibility: "off" }] }
        ];

        const styledMapType = new google.maps.StyledMapType(styles, {
            name: "POI Hidden",
            alt: "Hide Points of Interest"
        });

        map.mapTypes.set("hide_poi", styledMapType);

        // Listen for map type changes
        map.addListener('maptypeid_changed', function() {
            if (map.getMapTypeId() === 'hide_poi') {
                loadAndShowJsonLocations();
            } else {
                clearJsonLocations();
            }
        });
    }

    let jsonLocationMarkers = []; // Store JSON location markers

    function loadAndShowJsonLocations() {
        // Clear existing markers first
        clearJsonLocations();

        loadLocations().then(() => {
            locations.forEach(location => {
                const iconUrl = location[3];
                const markerOptions = {
                    position: new google.maps.LatLng(location[1], location[2]),
                    map: map
                };

                if (iconUrl) {
                    markerOptions.icon = {
                        url: iconUrl,
                        scaledSize: new google.maps.Size(30, 30)
                    };
                }

                const marker = new google.maps.Marker(markerOptions);
                jsonLocationMarkers.push(marker);

                if (!infoWindow) {
                    infoWindow = new google.maps.InfoWindow();
                }

                google.maps.event.addListener(marker, "click", () => {
                    const content = `
        <h2>Location Info</h2>
        ${location[3] ? `<img width="100%" src="${location[3]}"><br>` : ""}
        <p>${location[0]}</p>
    `;

                    document.getElementById("infoPanelContent").innerHTML = content;
                    document.getElementById("infoPanel").classList.add("visible");
                });


            });
        });
    }

    function clearJsonLocations() {
        jsonLocationMarkers.forEach(marker => marker.setMap(null));
        jsonLocationMarkers = [];
    }

    // Calculate Route
    function calculateRoute(travelMode = "DRIVING") {
        document.getElementById("transport-mode").innerHTML = travelMode;
        const start = document.getElementById("start").value;
        const end = document.getElementById("end").value;

        const request = {
            origin: start,
            destination: end,
            travelMode: travelMode
        };

        const directionsService = new google.maps.DirectionsService();

        directionsService.route(request, (route, status) => {
            if (status === google.maps.DirectionsStatus.OK) {
                directionsRenderer.setDirections(route);
            }
        });
    }

    document.addEventListener("DOMContentLoaded", () => {
        document.getElementById("closePanelBtn").addEventListener("click", () => {
            document.getElementById("infoPanel").classList.remove("visible");
        });
    });
</script>

<body>
<div id="header">
    text go here for header
</div>

<div id=controlPanel>
    <span class=selectLocationLabel>Start:</span>
    <input id=start type=text><br>

    <br>
    <span class=selectLocationLabel>End:</span>
    <input id=end type=text>

    <input type=button onclick=calculateRoute() id=submit value=Submit>
</div>

<div id="map-container">
    <div id="map"></div>
    <div id="map-controls">
        <div class="placeTypes">
            <input name="placeType" id="cafe" type="checkbox" value="cafe"
                   onchange="togglePlaceType('cafe', this.checked)" checked>
            <label for="cafe">Cafes</label>

            <input name="placeType" id="school" type="checkbox" value="school"
                   onchange="togglePlaceType('school', this.checked)">
            <label for="school">Schools</label>

            <input name="placeType" id="bar" type="checkbox" value="bar"
                   onchange="togglePlaceType('bar', this.checked)">
            <label for="bar">Bars</label>
        </div>
    </div>
</div>

<div id="infoPanel" class="hidden">
    <button id="closePanel">X</button>
    <div id="infoPanelContent"></div>
</div>

<div>
<!--fix later-->
    <button><i class=material-icons onclick=calculateRoute("DRIVING")>Car</i></button>
    <button><i class=material-icons onclick=calculateRoute("TRANSIT")>Bus</i></button>
    <button><i class=material-icons onclick=calculateRoute("BICYCLING")>Bike</i></button>
    <button><i class=material-icons onclick=calculateRoute("WALKING")>Walk</i></button>
</div>
<h1 id=transport-mode>Driving</h1>
<!--<details id=directions><summary>Directions</summary></details>-->

<!-- Google Maps -->
<script src=https://maps.googleapis.com/maps/api/js?key=AIzaSyB5dBhPCuFK_6J9DsLmrhyNY8C-VhDHaAk&loading=async&callback=loadMap&libraries=marker&libraries=places></script>
<div id="footer">
    text go here for footer
</div>
</body>
</html>