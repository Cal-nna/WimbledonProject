<!DOCTYPE html>
<html lang="en">

<head>
    <link href="styles/style.css" rel="stylesheet" type="text/css"/>
    <meta charset="UTF-8">
    <title>Wimbledon</title>
</head>

<script  type="text/javascript">
    let map = null;
    let directionsRenderer = null;
    let infoWindow = null;
    let service = null;
    let placeType = "restaurant";
    let markers = [];
    let locations = [];
    let latLng = null;
    let placeMarkers = {
        restaurant: [],
        museum: [],
        bar: [],
gas_station: [],
        hotel: []
    };

    // Load Map
    function loadMap() {
        const servicesCentreLocation = new google.maps.LatLng(51.43394571746091, -0.214533805847168);

        map = new google.maps.Map(document.getElementById("ch_map"), {
            mapId: "MY_MAP_ID",
            zoom: 16,
            center: servicesCentreLocation,
            mapTypeId: "hide_poi", // Set to hide_poi by default
            mapTypeControlOptions: {
                mapTypeIds: ["roadmap", "satellite", "hide_poi"]
            }
        });

        // Initialize directions service
        directionsService = new google.maps.DirectionsService();

        // Autocomplete Setup
        const startInput = document.getElementById("start");
        const endInput = document.getElementById("end");
        new google.maps.places.Autocomplete(startInput);
        new google.maps.places.Autocomplete(endInput);

        // Directions
        directionsRenderer = new google.maps.DirectionsRenderer({
            suppressMarkers: false
        });
        directionsRenderer.setMap(map);
        directionsRenderer.setPanel(document.getElementById("ch_directions"));

        hidePointsOfInterest(map);
        loadAndShowJsonLocations();

        service = new google.maps.places.PlacesService(map);

        // Load Locations
        locations.forEach(location => {
            const marker = new google.maps.Marker({
                position: new google.maps.LatLng(location.lat, location.lng),
                map: map
            });

            if (!infoWindow) {
                infoWindow = new google.maps.InfoWindow();
            }
        });

        // Click Listener
        map.addListener("click", (mapsMouseEvent) => {
            latLng = mapsMouseEvent.latLng.toJSON();

            // Check which place types are active and display them
            document.querySelectorAll('.placeTypes input[type="checkbox"]').forEach(checkbox => {
                if (checkbox.checked) {
                    togglePlaceType(checkbox.value, true);
                }
            });
        });
    }


    // Load External Locations File
    function loadLocations() {
        return fetch("locations.json")
            .then(response => {
                if (!response.ok) throw new Error("error fetching locations");
                return response.json();
            })
            .then(data => {
                locations = data; // Store the full objects now
                return data;
            })
            .catch(error => console.error("Error fetching locations: ", error));
    }

    // loadLocations().then(() => {
    //     locations.forEach(location => {
    //         const iconUrl = location[3];
    //         const markerOptions = {
    //             position: new google.maps.LatLng(location[1], location[2]),
    //             map: map
    //         };
    //
    //         if (iconUrl) {
    //             markerOptions.icon = {
    //                 url: iconUrl,
    //                 scaledSize: new google.maps.Size(30, 30)
    //             };
    //         }
    //
    //         const marker = new google.maps.Marker(markerOptions);
    //
    //         if (!infoWindow) {
    //             infoWindow = new google.maps.InfoWindow();
    //         }
    //
    //         google.maps.event.addListener(marker, "click", () => {
    //             infoWindow.setContent(location[0]);
    //             infoWindow.open(map, marker);
    //         });
    //     });
    // });

    // Toggle Nearby Place Types
    function togglePlaceType(type, isChecked) {
        if (isChecked) {
            if (latLng) {
                displayNearbyPlaces(type);
            }
        } else {
            clearPlaceMarkers(type);
        }
    }
    function clearPlaceMarkers(type) {
        placeMarkers[type].forEach(marker => {
            marker.setMap(null);
        });
        placeMarkers[type] = [];
    }

    // Display Nearby Places
    function displayNearbyPlaces(type) {
        // ✅ Reuse the global service instance declared above
        service.nearbySearch({
            location: latLng,
            radius: 1000,
            type: type
        }, (results, status) => {
            if (status === google.maps.places.PlacesServiceStatus.OK) {
                clearPlaceMarkers(type); // Clear existing markers of this type
                results.forEach(result => {
                    createPlaceMarker(result, type); // Call with type!
                });
            }
        });


        service.nearbySearch({
            location: latLng,
            radius: 1000,
            type: type
        }, (results, status) => {
            if (status === google.maps.places.PlacesServiceStatus.OK) {
                clearPlaceMarkers(type); // Clear existing markers of this type
                results.forEach(result => {
                    createPlaceMarker(result, type);
                });
            }
        });
    }


    // Callback: Create Nearby Markers
    function getNearbyServicesMarkers(results, status) {
        if (status === google.maps.places.PlacesServiceStatus.OK) {
            results.forEach(result => {
                createPlaceMarker(result);
            });
        }
    }

    // Create Place Marker
    function createPlaceMarker(place, type) {
        if (!place.geometry || !place.geometry.location) return;

        const marker = new google.maps.Marker({
            map: map,
            position: place.geometry.location,
            icon: {
                url: place.icon || "https://maps.gstatic.com/mapfiles/place_api/icons/v1/png_71/restaurant-71.png",
                scaledSize: new google.maps.Size(20, 20)
            }
        });

        placeMarkers[type].push(marker);

        google.maps.event.addListener(marker, "click", () => {
            const request = {
                placeId: place.place_id,
                fields: ["name", "formatted_address", "formatted_phone_number", "url", "photos"]
            };

            service.getDetails(request, (placeDetails, status) => {
                if (status !== google.maps.places.PlacesServiceStatus.OK || !placeDetails) return;

                const content = `
            <h2>${placeDetails.name}</h2>
            ${placeDetails.photos?.[0] ? `<img src="${placeDetails.photos[0].getUrl()}" width="100%">` : ""}
            <p>${placeDetails.formatted_address?.replaceAll(", ", ",<br>") || ""}</p>
            ${placeDetails.formatted_phone_number ? `<p>${placeDetails.formatted_phone_number}</p>` : ""}
            ${placeDetails.url ? `<p><a href="${placeDetails.url}" target="_blank">View on Google Maps</a></p>` : ""}
        `;
                showInfoPanel(content); // ✅ Use your side panel
            });
        });

    }

    // Hide POIs and Transit Icons
    function hidePointsOfInterest(map) {
        const styles = [
            { featureType: "poi", stylers: [{ visibility: "off" }] },
            { featureType: "transit", stylers: [{ visibility: "off" }] }
        ];

        const styledMapType = new google.maps.StyledMapType(styles, {
            name: "Wimbledon Map",
            alt: "Hide Points of Interest"
        });

        map.mapTypes.set("hide_poi", styledMapType);

        // Listen for map type changes
        map.addListener('maptypeid_changed', function() {
            if (map.getMapTypeId() === 'hide_poi') {
                loadAndShowJsonLocations();
            } else {
                clearJsonLocations();
            }
        });
    }

    let jsonLocationMarkers = []; // Store JSON location markers

    function loadAndShowJsonLocations() {
        clearJsonLocations();

        fetch("locations.json")
            .then(res => res.json())
            .then(data => {
                locations = data;

                let centerCourtLocation = null;
                let centerCourtMarker = null;

                locations.forEach(location => {
                    const marker = new google.maps.Marker({
                        position: { lat: location.lat, lng: location.lng },
                        map: map,
                        icon: location.icon ? {
                            url: location.icon,
                            scaledSize: new google.maps.Size(30, 30)
                        } : null
                    });

                    jsonLocationMarkers.push(marker);

                    google.maps.event.addListener(marker, "click", () => {
                        if (location.placeId) {
                            const request = {
                                placeId: location.placeId,
                                fields: ["name", "formatted_address", "formatted_phone_number", "url", "photos"]
                            };

                            service.getDetails(request, (placeDetails, status) => {
                                if (status === google.maps.places.PlacesServiceStatus.OK && placeDetails) {
                                    const mergedContent = `
                                    <h2>${placeDetails.name}</h2>
                                    ${location.img ? `<img width="100%" src="${location.img}"><br>` : ""}
                                    <p><strong>Address:</strong><br>${placeDetails.formatted_address?.replaceAll(", ", ",<br>")}</p>
                                    ${placeDetails.formatted_phone_number ? `<p><strong>Phone:</strong> ${placeDetails.formatted_phone_number}</p>` : ""}
                                    ${location.content ? `<p>${location.content}</p>` : ""}
                                    ${placeDetails.url ? `<p><a href="${placeDetails.url}" target="_blank">View on Google Maps</a></p>` : ""}
                                `;
                                    showInfoPanel(mergedContent);
                                }
                            });
                        } else {
                            const fallbackContent = `
                            ${location.img ? `<img width="100%" src="${location.img}"><br>` : ""}
                            <p>${location.content}</p>
                        `;
                            showInfoPanel(fallbackContent);
                        }
                    });

                    // Store reference if it's Centre Court
                    if (location.id === "centerCourt") {
                        centerCourtLocation = location;
                        centerCourtMarker = marker;
                    }
                });

                // After all markers are added, trigger Centre Court popup
                if (centerCourtMarker && centerCourtLocation) {
                    google.maps.event.trigger(centerCourtMarker, "click");
                    map.panTo({ lat: centerCourtLocation.lat, lng: centerCourtLocation.lng });
                }
            });
    }


    function clearJsonLocations() {
        jsonLocationMarkers.forEach(marker => marker.setMap(null));
        jsonLocationMarkers = [];
    }

    // Calculate Route
    function calculateRoute(travelMode = "DRIVING") {
        document.getElementById("transport-mode").innerHTML = travelMode;
        const start = document.getElementById("start").value;
        const end = document.getElementById("end").value;

        const request = {
            origin: start,
            destination: end,
            travelMode: travelMode
        };

        const directionsService = new google.maps.DirectionsService();

        directionsService.route(request, (route, status) => {
            if (status === google.maps.DirectionsStatus.OK) {
                directionsRenderer.setDirections(route);
            }
        });
    }

    document.addEventListener("DOMContentLoaded", () => {
        const tabButtons = document.querySelectorAll(".ch_tabButton");
        const tabContents = document.querySelectorAll(".ch_tabContent");

        tabButtons.forEach(btn => {
            btn.addEventListener("click", () => {
                // Remove "active" from all buttons and hide all tab contents
                tabButtons.forEach(b => b.classList.remove("active"));
                tabContents.forEach(tab => tab.classList.remove("visible"));

                // Activate clicked tab
                btn.classList.add("active");
                document.getElementById(btn.dataset.tab).classList.add("visible");
            });
        });
    });
    //
    // document.getElementById("ch_closePanel").addEventListener("click", () => {
    //     document.getElementById("ch_infoPanel").classList.remove("visible");
    //     document.body.classList.remove("panel-open");
    // });

    function showInfoPanel(content) {
        document.getElementById("ch_infoPanel").classList.add("visible");
        document.getElementById("ch_infoPanelContent").innerHTML = content;
        document.body.classList.add("panel-open");
    }

    function googleTranslateElementInit() {
        new google.translate.TranslateElement({
            pageLanguage: 'en',
            includedLanguages: 'en,fr,de,es,it,ja,zh-CN', // Add more language codes if needed
            layout: google.translate.TranslateElement.InlineLayout.SIMPLE
        }, 'ch_googleTranslateElement');
    }

    function addWaypoint() {
        const container = document.getElementById("waypointsContainer");
        const input = document.createElement("input");
        input.type = "text";
        input.classList.add("waypoint");
        container.appendChild(input);
        new google.maps.places.Autocomplete(input);
    }

</script>
<script src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

<body>
<div id="ch_header">
    <a href="index.html">
        <img src="https://upload.wikimedia.org/wikipedia/en/thumb/b/b9/Wimbledon.svg/800px-Wimbledon.svg.png" alt="Wimbledon Logo">
    </a>
    <div id="ch_googleTranslateElement"></div>
</div>

<div id="ch_mainContent">
    <div id="ch_infoPanel">
        <div class="ch_infoPanelTabs">
            <button class="ch_tabButton active" data-tab="ch_placesTab">Places Info</button>
            <button class="ch_tabButton" data-tab="ch_directionsTab">Directions</button>
        </div>

        <div id="ch_placesTab" class="ch_tabContent visible">
            <div id="ch_infoPanelContent"></div>
        </div>

        <div id="ch_directionsTab" class="ch_tabContent">
            <div id="ch_controlPanel">
                <span class="ch_selectLocationLabel">Start:</span>
                <span class="ch_selectLocationLabel">Start:</span>
                <input id="start" type="text"><br><br>

                <div id="waypointsContainer"></div>
                <button type="button" onclick="addWaypoint()">+ Add Stop</button><br><br>

                <span class="ch_selectLocationLabel">End:</span>
                <input id="end" type="text"><br><br>

                <input type="button" onclick="calculateRoute()" id="submit" value="Submit">

            </div>
            <div>
                <button><i class="material-icons" onclick="calculateRoute('DRIVING')">Car</i></button>
                <button><i class="material-icons" onclick="calculateRoute('TRANSIT')">Bus</i></button>
                <button><i class="material-icons" onclick="calculateRoute('BICYCLING')">Bike</i></button>
                <button><i class="material-icons" onclick="calculateRoute('WALKING')">Walk</i></button>
            </div>
            <h1 id="transport-mode"></h1>
            <div id="ch_directions"></div>
        </div>
    </div>

    <div id="ch_mapContainer">
        <div id="ch_map"></div>
        <div id="ch_mapControls">
            <div class="ch_placeTypes">
                <input name="placeType" id="restaurant" type="checkbox" value="restaurant"
                       onchange="togglePlaceType('restaurant', this.checked)" checked>
                <label for="restaurant">Restaurants</label>

                <input name="placeType" id="museum" type="checkbox" value="museum"
                       onchange="togglePlaceType('museum', this.checked)">
                <label for="museum">Museums</label>

                <input name="placeType" id="bar" type="checkbox" value="bar"
                       onchange="togglePlaceType('bar', this.checked)">
                <label for="bar">Bars</label>

                <input name="placeType" id="gas_station" type="checkbox" value="gas_station"
                       onchange="togglePlaceType('gas_station', this.checked)">
                <label for="gas_station">Fuel</label>

                <input name="placeType" id="hotel" type="checkbox" value="hotel"
                       onchange="togglePlaceType('hotel', this.checked)">
                <label for="hotel">Hotels</label>
            </div>
        </div>
    </div>
</div>

<div id="ch_footer">
    text go here for footer
</div>

<!-- Google Maps -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB5dBhPCuFK_6J9DsLmrhyNY8C-VhDHaAk&loading=async&callback=loadMap&libraries=marker&libraries=places"></script>
</body>
</html>